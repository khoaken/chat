<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>H·ªì s∆° - KKChat</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ChatUp" />
  <meta name="theme-color" content="#4a90e2" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .dark-mode { background: #1a202c; color: #e2e8f0; }
    .dark-mode .bg-white { background: #2d3748; }
    .dark-mode .bg-gray-100 { background: #1a202c; }
    .dark-mode .border-gray-200 { border-color: #4a5568; }
    .dark-mode input, .dark-mode button, .dark-mode textarea { background: #4a5568; color: #e2e8f0; border-color: #718096; }
    .friend-item, .status-item { transition: all 0.2s ease; }
    .friend-item:hover, .status-item:hover { transform: translateY(-2px); }
    .avatar-initial {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #4a90e2;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.2rem;
      text-transform: uppercase;
      border: 2px solid #3578c6;
    }
    .avatar-initial-large {
      width: 100px;
      height: 100px;
      font-size: 2.5rem;
    }
    .status-input { resize: none; }
    .status-item { border: 1px solid #e2e8f0; border-radius: 8px; }
    .dark-mode .status-item { border-color: #4a5568; }
    .status-text { font-size: 1.1rem; line-height: 1.5; }
    .status-time { font-size: 0.85rem; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; }
    .dark-mode .modal-content { background: #2d3748; }
    .verified-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(45deg, #00f, #0ff);
      color: white;
      font-size: 0.9rem;
      margin-left: 5px;
      position: relative;
      transition: transform 0.2s ease;
    }
    .verified-badge:hover {
      transform: scale(1.1);
    }
    .verified-badge:hover::after {
      content: 'ƒê√¢y l√† ng∆∞·ªùi n·ªïi ti·∫øng';
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: #2d3748;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
    }
    .dark-mode .verified-badge:hover::after {
      background: #e2e8f0;
      color: #1a202c;
    }
    .like-button.liked {
      color: #e53e3e;
      font-weight: bold;
    }
    .comment-section {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e2e8f0;
    }
    .dark-mode .comment-section {
      border-top: 1px solid #4a5568;
    }
    .comment-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .comment-input {
      resize: none;
      font-size: 0.9rem;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4a90e2;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 100;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    @media (max-width: 640px) {
      .status-text { font-size: 1rem; }
      .avatar-initial { width: 36px; height: 36px; font-size: 1rem; }
      .verified-badge { width: 18px; height: 18px; font-size: 0.8rem; }
      .verified-badge:hover::after { font-size: 0.7rem; top: -25px; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-semibold text-blue-600">H·ªì s∆°</h2>
      <div class="flex items-center gap-4">
        <button id="dark-toggle" class="text-xl bg-transparent border-none">üåô</button>
        <button onclick="window.location.href='index.html'" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Quay l·∫°i</button>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <div class="flex items-center gap-6 mb-4">
        <div id="profile-pic" class="avatar-initial avatar-initial-large"></div>
        <div>
          <h3 id="profile-name" class="text-xl font-semibold"></h3>
          <input type="file" id="profile-pic-input" accept="image/*" class="hidden">
          <button id="upload-pic-button" class="mt-2 bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 hidden">ƒê·ªïi ·∫£nh</button>
        </div>
      </div>
      <button id="message-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 hidden">Nh·∫Øn tin</button>
    </div>

    <div id="post-status-section" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
      <h3 class="text-lg font-semibold mb-4">ƒêƒÉng tr·∫°ng th√°i</h3>
      <textarea id="status-input" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 status-input" placeholder="B·∫°n ƒëang nghƒ© g√¨?" rows="3"></textarea>
      <button id="post-status-button" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">ƒêƒÉng</button>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h3 class="text-lg font-semibold mb-4">Tr·∫°ng th√°i</h3>
      <div id="status-list"></div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <h3 class="text-lg font-semibold mb-4">Danh s√°ch b·∫°n b√®</h3>
      <div id="friends-list"></div>
    </div>

    <div id="edit-status-modal" class="modal">
      <div class="modal-content">
        <h3 class="text-lg font-semibold mb-4">Ch·ªânh s·ª≠a tr·∫°ng th√°i</h3>
        <textarea id="edit-status-input" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 status-input" rows="3"></textarea>
        <div class="flex gap-2">
          <button id="save-status-button" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">L∆∞u</button>
          <button id="cancel-status-button" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">H·ªßy</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAry2Wta_2_mWxfplmfnpHn3aBSpH-ZDqU",
  authDomain: "chatup-7fed7.firebaseapp.com",
  projectId: "chatup-7fed7",
  storageBucket: "chatup-7fed7.appspot.com",
  messagingSenderId: "287838782402",
  appId: "1:287838782402:web:c4fd4b4ce02c3238530c5b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let profileUid = null;
let currentUserData = null;

function showToast(message) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerText = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function loadProfile(userData, uid, isOwnProfile) {
  const profileName = document.getElementById("profile-name");
  profileName.innerText = userData.name || "Ng∆∞·ªùi d√πng";
  if (userData.isVerified) {
    profileName.innerHTML += `<span class="verified-badge">‚úî</span>`;
  }
  const profilePic = document.getElementById("profile-pic");
  profilePic.innerText = userData.name ? userData.name.charAt(0).toUpperCase() : "U";
  document.getElementById("post-status-section").classList.toggle("hidden", !isOwnProfile);
  if (!isOwnProfile && uid !== currentUser.uid) {
    const messageButton = document.getElementById("message-button");
    messageButton.classList.remove("hidden");
    messageButton.onclick = () => window.location.href = `chat.html?uid=${uid}`;
  }
}

function loadFriends(uid) {
  const friendsList = document.getElementById("friends-list");
  const friendsRef = collection(db, "friends", uid, "list");
  onSnapshot(friendsRef, async (snapshot) => {
    friendsList.innerHTML = "";
    for (const docSnap of snapshot.docs) {
      const friendId = docSnap.id;
      const userSnap = await getDoc(doc(db, "users", friendId));
      const data = userSnap.data();
      const div = document.createElement("div");
      div.className = "friend-item bg-gray-50 p-3 rounded-lg flex justify-between items-center";
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="avatar-initial">${data?.name ? data.name.charAt(0).toUpperCase() : "U"}</div>
          <span class="font-semibold">${data?.name || "Ng∆∞·ªùi d√πng"}${data?.isVerified ? '<span class="verified-badge">‚úî</span>' : ""}</span>
        </div>
        <div class="flex gap-2">
          <button onclick="window.location.href='profile.html?uid=${friendId}'" class="bg-gray-600 text-white px-3 py-1 rounded-lg hover:bg-gray-700">Xem h·ªì s∆°</button>
          <button onclick="window.location.href='chat.html?uid=${friendId}'" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">Nh·∫Øn tin</button>
        </div>
      `;
      friendsList.appendChild(div);
    }
  });
}

function formatTime(timestamp) {
  const date = timestamp.toDate();
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.round(diffMs / 60000);
  if (diffMins < 1) return "V·ª´a xong";
  if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
  const diffHours = Math.round(diffMins / 60);
  if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
  return date.toLocaleString();
}

function loadStatuses(uid, isOwnProfile) {
  const statusList = document.getElementById("status-list");
  const statusesRef = collection(db, "users", uid, "statuses");
  const q = query(statusesRef, orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    statusList.innerHTML = "";
    snapshot.forEach(docSnap => {
      const status = docSnap.data();
      const statusId = docSnap.id;
      const timeStr = formatTime(status.createdAt);
      const likesCount = status.likes?.length || 0;
      const isLiked = status.likes?.includes(currentUser?.uid) || false;
      const div = document.createElement("div");
      div.className = "status-item bg-gray-50 p-4 mb-4 shadow-sm";
      div.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="avatar-initial">${currentUserData?.name ? currentUserData.name.charAt(0).toUpperCase() : "U"}</div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-semibold">${currentUserData?.name || "Ng∆∞·ªùi d√πng"}${currentUserData?.isVerified ? '<span class="verified-badge">‚úî</span>' : ""}</span>
            </div>
            <p class="status-text mt-1">${status.text}</p>
            <p class="status-time text-gray-500 mt-1">${timeStr}${status.updatedAt ? ' (ƒê√£ ch·ªânh s·ª≠a)' : ''}</p>
            <div class="flex gap-4 mt-2">
              <button class="like-button text-sm text-gray-600 hover:text-red-600 ${isLiked ? 'liked' : ''}" onclick="toggleLike('${statusId}', '${uid}', ${isLiked})">
                ‚ù§Ô∏è Th√≠ch (${likesCount})
              </button>
              <button class="comment-button text-sm text-gray-600 hover:text-blue-600" onclick="toggleCommentSection('comment-section-${statusId}')">
                üí¨ B√¨nh lu·∫≠n
              </button>
              ${isOwnProfile ? `
                <div class="flex gap-2">
                  <button onclick="editStatus('${statusId}', '${status.text.replace(/'/g, "\\'")}')" class="text-blue-600 text-sm hover:underline">S·ª≠a</button>
                  <button onclick="deleteStatus('${statusId}')" class="text-red-600 text-sm hover:underline">X√≥a</button>
                </div>
              ` : ''}
            </div>
            <div id="comment-section-${statusId}" class="comment-section">
              <div id="comment-list-${statusId}" class="mt-2"></div>
              <textarea id="comment-input-${statusId}" class="w-full p-2 mt-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." rows="2"></textarea>
              <button class="mt-2 bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700" onclick="postComment('${statusId}', '${uid}')">G·ª≠i</button>
            </div>
          </div>
        </div>
      `;
      statusList.appendChild(div);
      loadComments(uid, statusId);
    });
  });
}

function loadComments(uid, statusId) {
  const commentList = document.getElementById(`comment-list-${statusId}`);
  const commentsRef = collection(db, "users", uid, "statuses", statusId, "comments");
  const q = query(commentsRef, orderBy("createdAt", "asc"));
  onSnapshot(q, (snapshot) => {
    commentList.innerHTML = "";
    snapshot.forEach(docSnap => {
      const comment = docSnap.data();
      const div = document.createElement("div");
      div.className = "comment-item";
      div.innerHTML = `
        <div class="avatar-initial" style="width: 32px; height: 32px; font-size: 1rem;">${comment.name ? comment.name.charAt(0).toUpperCase() : "U"}</div>
        <div>
          <div class="flex items-center gap-2">
            <span class="font-semibold text-sm">${comment.name || "Ng∆∞·ªùi d√πng"}${comment.isVerified ? '<span class="verified-badge" style="width: 16px; height: 16px; font-size: 0.7rem;">‚úî</span>' : ""}</span>
          </div>
          <p class="text-sm">${comment.text}</p>
          <p class="text-xs text-gray-500">${formatTime(comment.createdAt)}</p>
        </div>
      `;
      commentList.appendChild(div);
    });
  });
}

window.toggleLike = async (statusId, uid, isLiked) => {
  if (!currentUser) {
    showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch tr·∫°ng th√°i!");
    return;
  }
  try {
    const statusRef = doc(db, "users", uid, "statuses", statusId);
    if (isLiked) {
      await updateDoc(statusRef, {
        likes: arrayRemove(currentUser.uid)
      });
      showToast("ƒê√£ b·ªè th√≠ch tr·∫°ng th√°i.");
    } else {
      await updateDoc(statusRef, {
        likes: arrayUnion(currentUser.uid)
      });
      showToast("ƒê√£ th√≠ch tr·∫°ng th√°i!");
    }
  } catch (error) {
    showToast(`L·ªói khi th√≠ch tr·∫°ng th√°i: ${error.message}`);
  }
};

window.toggleCommentSection = (sectionId) => {
  const section = document.getElementById(sectionId);
  section.style.display = section.style.display === "block" ? "none" : "block";
};

window.postComment = async (statusId, uid) => {
  if (!currentUser) {
    showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n!");
    return;
  }
  const commentInput = document.getElementById(`comment-input-${statusId}`);
  const commentText = commentInput.value.trim();
  if (!commentText) {
    showToast("B√¨nh lu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
    return;
  }
  try {
    const commentsRef = collection(db, "users", uid, "statuses", statusId, "comments");
    await addDoc(commentsRef, {
      userId: currentUser.uid,
      name: currentUserData.name || "Ng∆∞·ªùi d√πng",
      isVerified: currentUserData.isVerified || false,
      text: commentText,
      createdAt: new Date()
    });
    commentInput.value = "";
    showToast("ƒê√£ ƒëƒÉng b√¨nh lu·∫≠n!");
  } catch (error) {
    showToast(`L·ªói khi ƒëƒÉng b√¨nh lu·∫≠n: ${error.message}`);
  }
};

document.getElementById("upload-pic-button").addEventListener("click", () => {
  document.getElementById("profile-pic-input").click();
});

document.getElementById("profile-pic-input").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file || !currentUser) {
    showToast("Vui l√≤ng ch·ªçn file ·∫£nh ho·∫∑c ƒëƒÉng nh·∫≠p l·∫°i.");
    return;
  }

  try {
    if (!file.type.startsWith("image/")) {
      showToast("Vui l√≤ng ch·ªçn file ·∫£nh (jpg, png, ...).");
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      showToast("File ·∫£nh qu√° l·ªõn. Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.");
      return;
    }

    const fileRef = ref(storage, `profile_pics/${currentUser.uid}/${Date.now()}_${file.name}`);
    await uploadBytes(fileRef, file);
    const fileURL = await getDownloadURL(fileRef);
    await updateDoc(doc(db, "users", currentUser.uid), { profilePic: fileURL });
    currentUserData.profilePic = fileURL;
    event.target.value = "";
    showToast("C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!");
  } catch (error) {
    showToast(`L·ªói khi upload ·∫£nh: ${error.message}`);
  }
});

document.getElementById("post-status-button").addEventListener("click", async () => {
  const statusText = document.getElementById("status-input").value.trim();
  if (!statusText || !currentUser) {
    showToast("Tr·∫°ng th√°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
    return;
  }

  try {
    const statusesRef = collection(db, "users", currentUser.uid, "statuses");
    await addDoc(statusesRef, {
      text: statusText,
      createdAt: new Date(),
      likes: []
    });
    document.getElementById("status-input").value = "";
    showToast("ƒêƒÉng tr·∫°ng th√°i th√†nh c√¥ng!");
  } catch (error) {
    showToast(`L·ªói khi ƒëƒÉng tr·∫°ng th√°i: ${error.message}`);
  }
});

window.editStatus = (statusId, currentText) => {
  const modal = document.getElementById("edit-status-modal");
  const input = document.getElementById("edit-status-input");
  input.value = currentText;
  modal.style.display = "flex";

  document.getElementById("save-status-button").onclick = async () => {
    const newText = input.value.trim();
    if (!newText) {
      showToast("Tr·∫°ng th√°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
      return;
    }
    try {
      await updateDoc(doc(db, "users", currentUser.uid, "statuses", statusId), {
        text: newText,
        updatedAt: new Date()
      });
      modal.style.display = "none";
      showToast("Ch·ªânh s·ª≠a tr·∫°ng th√°i th√†nh c√¥ng!");
    } catch (error) {
      showToast(`L·ªói khi ch·ªânh s·ª≠a tr·∫°ng th√°i: ${error.message}`);
    }
  };

  document.getElementById("cancel-status-button").onclick = () => {
    modal.style.display = "none";
  };
};

window.deleteStatus = async (statusId) => {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tr·∫°ng th√°i n√†y?")) return;
  try {
    await deleteDoc(doc(db, "users", currentUser.uid, "statuses", statusId));
    showToast("X√≥a tr·∫°ng th√°i th√†nh c√¥ng!");
  } catch (error) {
    showToast(`L·ªói khi x√≥a tr·∫°ng th√°i: ${error.message}`);
  }
};

document.getElementById("dark-toggle").addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
});

if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  currentUser = user;
  const urlParams = new URLSearchParams(window.location.search);
  profileUid = urlParams.get("uid") || user.uid;
  const isOwnProfile = profileUid === user.uid;

  try {
    const userSnap = await getDoc(doc(db, "users", profileUid));
    if (!userSnap.exists()) {
      showToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng.");
      window.location.href = "index.html";
      return;
    }
    const userData = userSnap.data();
    currentUserData = userData;
    loadProfile(userData, profileUid, isOwnProfile);
    loadFriends(profileUid);
    loadStatuses(profileUid, isOwnProfile);
  } catch (error) {
    showToast(`L·ªói khi t·∫£i h·ªì s∆°: ${error.message}`);
    window.location.href = "index.html";
  }
});
</script>
</body>
</html>

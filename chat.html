<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KKChat - Tr√≤ chuy·ªán</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ChatUp" />
  <meta name="theme-color" content="#4a90e2" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/index.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: url('https://www.transparenttextures.com/patterns/cute-pattern.png') repeat, #f0f4f8;
      background-size: 200px;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .chat-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      overflow: hidden; /* NgƒÉn overflow */
    }
    .chat-header {
      padding: 15px;
      background: #4a90e2;
      color: white;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .pinned-message {
      background: #fefcbf;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pinned-message .message-content {
      max-width: 80%;
    }
    .message {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 15px;
      line-height: 1.5;
      position: relative;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.sent {
      background: #4a90e2;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    .message.received {
      background: #e2e8f0;
      color: #1a202c;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    .message img {
      max-width: 200px;
      border-radius: 10px;
      margin-top: 5px;
    }
    .message-time {
      font-size: 0.75rem;
      color: #718096;
      margin-top: 5px;
      text-align: right;
    }
    .message.received .message-time {
      text-align: left;
    }
    .message.no-time .message-time {
      display: none;
    }
    .date-divider {
      text-align: center;
      color: #718096;
      font-size: 0.85rem;
      margin: 10px 0;
    }
    .message-actions {
      display: none;
      position: absolute;
      top: -30px;
      right: 10px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    .message:hover .message-actions {
      display: block;
    }
    .message-actions button {
      display: block;
      padding: 5px 10px;
      background: none;
      border: none;
      color: #1a202c;
      cursor: pointer;
    }
    .message-actions button:hover {
      background: #e2e8f0;
    }
    .reaction-picker {
      display: none;
      position: absolute;
      top: -50px;
      left: 10px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    .message:hover .reaction-picker {
      display: flex;
      gap: 5px;
    }
    .reaction-picker button {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .reactions {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      font-size: 0.9rem;
    }
    .reaction {
      background: #e2e8f0;
      border-radius: 10px;
      padding: 2px 8px;
    }
    .message.sent .reaction {
      background: #a3bffa;
    }
    .read-receipt {
      font-size: 0.8rem;
      color: #48bb78;
      margin-top: 2px;
      text-align: right;
    }
    .message.received .read-receipt {
      text-align: left;
    }
    .chat-input {
      display: flex;
      gap: 8px;
      padding: 10px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      background: #fff;
      border-top: 1px solid #e2e8f0;
      border-radius: 0 0 10px 10px;
      position: relative;
      align-items: center;
      overflow: hidden;
      box-sizing: border-box;
    }
    .chat-input input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      outline: none;
      font-size: 0.9rem;
      max-width: calc(100% - 120px);
    }
    .chat-input button {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    .chat-input button:hover {
      background: #3578c6;
    }
    .emoji-button, .image-upload-button {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
    emoji-picker {
      position: absolute;
      bottom: 60px;
      left: 20px;
      z-index: 10;
      display: none;
    }
    #image-upload {
      display: none;
    }
    .typing-indicator {
      font-size: 0.85rem;
      color: #718096;
      padding: 10px 20px;
      display: none;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #e53e3e;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 100;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    .dark-mode {
      background: url('https://www.transparenttextures.com/patterns/cute-pattern.png') repeat, #1a202c;
      color: #e2e8f0;
    }
    .dark-mode .chat-container {
      background: rgba(45, 55, 72, 0.9);
    }
    .dark-mode .chat-header {
      background: #2b6cb0;
    }
    .dark-mode .message.received {
      background: #4a5568;
      color: #e2e8f0;
    }
    .dark-mode .pinned-message {
      background: #4a5568;
    }
    .dark-mode .chat-input {
      background: #2d3748;
      border-top: 1px solid #4a5568;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
    }
    .dark-mode .chat-input input {
      background: #4a5568;
      border-color: #718096;
      color: #e2e8f0;
    }
    .dark-mode .message-actions, .dark-mode .reaction-picker {
      background: #2d3748;
      border-color: #4a5568;
    }
    .dark-mode .message-actions button:hover, .dark-mode .reaction-picker button:hover {
      background: #4a5568;
    }
    .dark-mode .reaction {
      background: #4a5568;
    }
    .dark-mode .message.sent .reaction {
      background: #2b6cb0;
    }
    .profile-pic {
      object-fit: cover;
      border: 2px solid #4a90e2;
    }
    @media (max-width: 640px) {
      .chat-container {
        padding: 8px;
        height: 100vh;
        margin: 0;
        border-radius: 0;
      }
      .chat-input {
        padding: 8px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
        gap: 6px;
        flex-wrap: nowrap;
      }
      .chat-input input {
        font-size: 0.85rem;
        padding: 6px 10px;
        max-width: calc(100% - 100px);
      }
      .chat-input button {
        padding: 6px 12px;
        font-size: 0.85rem;
      }
      .emoji-button, .image-upload-button {
        font-size: 1rem;
      }
      .message {
        max-width: 85%;
      }
    }
    @media (max-width: 430px) {
      .chat-input input {
        max-width: calc(100% - 90px);
      }
      .chat-input button {
        padding: 6px 10px;
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="chat-container">
    <div class="chat-header">
      <div class="flex items-center gap-3">
        <img id="friend-pic" src="https://via.placeholder.com/40" alt="Friend Avatar" class="w-10 h-10 rounded-full profile-pic">
        <h2 id="friend-name" class="text-lg font-semibold"></h2>
      </div>
      <button id="back-button" class="bg-transparent text-white text-xl border-none">‚Üê</button>
    </div>
    <div id="pinned-message" class="pinned-message hidden"></div>
    <div class="chat-messages" id="messages">
      <!-- Messages will be dynamically added here -->
    </div>
    <div class="typing-indicator" id="typing-indicator">ƒêang g√µ...</div>
    <div class="chat-input">
      <button class="emoji-button" id="emoji-button">üòä</button>
      <emoji-picker id="emoji-picker"></emoji-picker>
      <button class="image-upload-button" id="image-upload-button">üì∑</button>
      <input type="file" accept="image/*" id="image-upload">
      <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
      <button id="send-button">G·ª≠i</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, addDoc, deleteDoc, serverTimestamp, query, orderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
    import 'https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/index.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAry2Wta_2_mWxfplmfnpHn3aBSpH-ZDqU",
      authDomain: "chatup-7fed7.firebaseapp.com",
      projectId: "chatup-7fed7",
      storageBucket: "chatup-7fed7.appspot.com",
      messagingSenderId: "287838782402",
      appId: "1:287838782402:web:c4fd4b4ce02c3238530c5b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    let lastMessageDate = null;
    let lastSenderId = null;
    let lastSentMessageId = null;

    function getChatId(userId1, userId2) {
      return [userId1, userId2].sort().join('_');
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate();
      return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate();
      return date.toLocaleDateString('vi-VN', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function loadFriendInfo(friendId) {
      const friendRef = doc(db, "users", friendId);
      const friendSnap = await getDoc(friendRef);
      if (friendSnap.exists()) {
        const friendData = friendSnap.data();
        document.getElementById("friend-name").innerText = friendData.name || "Ng∆∞·ªùi d√πng";
        document.getElementById("friend-name").innerHTML += friendData.isVerified ? " ‚úÖ" : "";
        document.getElementById("friend-pic").src = friendData.profilePic || "https://via.placeholder.com/40";
      }
    }

    async function loadPinnedMessage(chatId, userId) {
      const chatRef = doc(db, "chats", chatId);
      const chatSnap = await getDoc(chatRef);
      const pinnedMessageId = chatSnap.data()?.pinnedMessageId;
      const pinnedMessageDiv = document.getElementById("pinned-message");
      if (pinnedMessageId) {
        const msgRef = doc(db, "chats", chatId, "messages", pinnedMessageId);
        const msgSnap = await getDoc(msgRef);
        if (msgSnap.exists()) {
          const msg = msgSnap.data();
          pinnedMessageDiv.className = "pinned-message";
          let content = `<div class="message-content">${msg.text || ""}`;
          if (msg.imageUrl) {
            content += `<img src="${msg.imageUrl}" alt="Pinned image">`;
          }
          content += `</div>`;
          content += `<button class="unpin-button" data-msg-id="${msgSnap.id}">B·ªè ghim</button>`;
          pinnedMessageDiv.innerHTML = content;
          pinnedMessageDiv.classList.remove("hidden");

          pinnedMessageDiv.querySelector(".unpin-button").addEventListener("click", async () => {
            await updateDoc(chatRef, { pinnedMessageId: null });
            pinnedMessageDiv.classList.add("hidden");
            pinnedMessageDiv.innerHTML = "";
          });
        }
      } else {
        pinnedMessageDiv.classList.add("hidden");
      }
    }

    function loadMessages(userId, friendId) {
      const chatId = getChatId(userId, friendId);
      const messagesRef = collection(db, "chats", chatId, "messages");
      const q = query(messagesRef, orderBy("timestamp", "asc"));
      let messages = [];
      onSnapshot(q, (snapshot) => {
        messages = [];
        snapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });

        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";
        lastMessageDate = null;
        lastSenderId = null;

        const lastSentMessage = messages
          .filter(msg => msg.senderId === userId)
          .slice(-1)[0];

        messages.forEach((msg, index) => {
          const msgDate = msg.timestamp ? formatDate(msg.timestamp) : '';
          if (msgDate && msgDate !== lastMessageDate) {
            lastMessageDate = msgDate;
            const divider = document.createElement("div");
            divider.className = "date-divider";
            divider.innerText = msgDate;
            messagesDiv.appendChild(divider);
          }
          const messageDiv = document.createElement("div");
          const isSameSender = lastSenderId === msg.senderId;
          lastSenderId = msg.senderId;
          messageDiv.className = `message ${msg.senderId === userId ? "sent" : "received"} ${isSameSender ? "no-time" : ""}`;
          messageDiv.dataset.msgId = msg.id;
          let content = `<div>${msg.text || ""}</div>`;
          if (msg.imageUrl) {
            content += `<img src="${msg.imageUrl}" alt="Attached image">`;
          }
          content += `<div class="message-time">${formatTime(msg.timestamp)}</div>`;
          if (msg.senderId === userId && msg.id === lastSentMessage?.id && msg.readBy?.includes(friendId)) {
            content += `<div class="read-receipt">ƒê√£ ƒë·ªçc ‚úÖ</div>`;
          }
          if (msg.reactions) {
            content += `<div class="reactions">`;
            Object.entries(msg.reactions).forEach(([emoji, users]) => {
              content += `<span class="reaction">${emoji} ${users.length}</span>`;
            });
            content += `</div>`;
          }
          if (msg.senderId === userId) {
            content += `
              <div class="message-actions">
                <button class="pin-button" data-msg-id="${msg.id}">Ghim</button>
                <button class="recall-button" data-msg-id="${msg.id}">Thu h·ªìi</button>
              </div>
            `;
          }
          content += `
            <div class="reaction-picker">
              <button class="react-button" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
              <button class="react-button" data-emoji="üòÇ">üòÇ</button>
              <button class="react-button" data-emoji="üëç">üëç</button>
              <button class="react-button" data-emoji="üòÆ">üòÆ</button>
            </div>
          `;
          messageDiv.innerHTML = content;
          messagesDiv.appendChild(messageDiv);

          if (msg.senderId === userId) {
            messageDiv.querySelector(".pin-button")?.addEventListener("click", async () => {
              const chatRef = doc(db, "chats", chatId);
              await updateDoc(chatRef, { pinnedMessageId: msg.id });
              loadPinnedMessage(chatId, userId);
            });
            messageDiv.querySelector(".recall-button")?.addEventListener("click", async () => {
              await deleteDoc(doc(db, "chats", chatId, "messages", msg.id));
              const chatRef = doc(db, "chats", chatId);
              const chatSnap = await getDoc(chatRef);
              if (chatSnap.data()?.pinnedMessageId === msg.id) {
                await updateDoc(chatRef, { pinnedMessageId: null });
              }
            });
          }
          messageDiv.querySelectorAll(".react-button").forEach(button => {
            button.addEventListener("click", async () => {
              const emoji = button.dataset.emoji;
              const msgRef = doc(db, "chats", chatId, "messages", msg.id);
              await updateDoc(msgRef, {
                [`reactions.${emoji}`]: arrayUnion(userId)
              });
            });
          });

          if (msg.senderId !== userId && !msg.readBy?.includes(userId)) {
            updateDoc(doc(db, "chats", chatId, "messages", msg.id), {
              readBy: arrayUnion(userId)
            });
          }
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        loadPinnedMessage(chatId, userId);
      });
    }

    function setupTypingIndicator(userId, friendId) {
      const chatId = getChatId(userId, friendId);
      const typingRef = doc(db, "chats", chatId, "typing", friendId);
      onSnapshot(typingRef, (doc) => {
        const typingIndicator = document.getElementById("typing-indicator");
        if (doc.exists() && doc.data().isTyping) {
          typingIndicator.style.display = "block";
        } else {
          typingIndicator.style.display = "none";
        }
      });
    }

    document.getElementById("send-button").addEventListener("click", async () => {
      const messageInput = document.getElementById("message-input");
      const text = messageInput.value.trim();
      if (!text) return;

      const urlParams = new URLSearchParams(window.location.search);
      const friendId = urlParams.get("uid");
      const userId = auth.currentUser.uid;
      const chatId = getChatId(userId, friendId);

      try {
        await addDoc(collection(db, "chats", chatId, "messages"), {
          senderId: userId,
          text: text,
          timestamp: serverTimestamp(),
          readBy: [userId],
          reactions: {}
        });
        messageInput.value = "";
      } catch (error) {
        showToast(`L·ªói khi g·ª≠i tin nh·∫Øn: ${error.message}`);
      }
    });

    document.getElementById("image-upload").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const urlParams = new URLSearchParams(window.location.search);
      const friendId = urlParams.get("uid");
      const userId = auth.currentUser.uid;
      const chatId = getChatId(userId, friendId);

      try {
        const storageRef = ref(storage, `chat_images/${chatId}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        const imageUrl = await getDownloadURL(storageRef);
        await addDoc(collection(db, "chats", chatId, "messages"), {
          senderId: userId,
          text: "",
          imageUrl: imageUrl,
          timestamp: serverTimestamp(),
          readBy: [userId],
          reactions: {}
        });
        e.target.value = "";
      } catch (error) {
        showToast(`L·ªói khi t·∫£i ·∫£nh l√™n: ${error.message}`);
      }
    });

    document.getElementById("image-upload-button").addEventListener("click", () => {
      document.getElementById("image-upload").click();
    });

    document.getElementById("message-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        document.getElementById("send-button").click();
      }
    });

    document.getElementById("message-input").addEventListener("input", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const friendId = urlParams.get("uid");
      const userId = auth.currentUser.uid;
      const chatId = getChatId(userId, friendId);
      const typingRef = doc(db, "chats", chatId, "typing", userId);
      await setDoc(typingRef, { isTyping: true });
      setTimeout(async () => {
        await setDoc(typingRef, { isTyping: false });
      }, 3000);
    });

    document.getElementById("emoji-button").addEventListener("click", () => {
      const picker = document.getElementById("emoji-picker");
      picker.style.display = picker.style.display === "block" ? "none" : "block";
    });

    document.getElementById("emoji-picker").addEventListener("emoji-click", (event) => {
      const messageInput = document.getElementById("message-input");
      messageInput.value += event.detail.unicode;
      messageInput.focus();
      document.getElementById("emoji-picker").style.display = "none";
    });

    document.getElementById("back-button").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark-mode");
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const friendId = urlParams.get("uid");
      if (!friendId) {
        showToast("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ tr√≤ chuy·ªán!");
        window.location.href = "index.html";
        return;
      }

      try {
        await loadFriendInfo(friendId);
        loadMessages(user.uid, friendId);
        setupTypingIndicator(user.uid, friendId);
        const chatId = getChatId(user.uid, friendId);
        const chatRef = doc(db, "chats", chatId);
        const chatSnap = await getDoc(chatRef);
        if (!chatSnap.exists()) {
          await setDoc(chatRef, { pinnedMessageId: null });
        }
      } catch (error) {
        showToast(`L·ªói khi t·∫£i cu·ªôc tr√≤ chuy·ªán: ${error.message}`);
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>

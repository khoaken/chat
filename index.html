<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatUp</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Chat" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    h2 {
      margin-top: 0;
    }
    #chat {
      border: 1px solid #ccc;
      background: white;
      height: 300px;
      overflow-y: scroll;
      margin-bottom: 10px;
      padding: 10px;
    }
    .msg {
      margin: 5px 0;
      padding: 5px 10px;
      border-radius: 10px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .my-msg {
      background: #DCF8C6;
      text-align: right;
      margin-left: auto;
    }
    .other-msg {
      background: #eee;
      text-align: left;
      margin-right: auto;
    }
    .msg b {
      display: block;
    }
    #auth input, #chat-ui input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    button {
      padding: 8px 12px;
      margin-top: 5px;
      cursor: pointer;
    }
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    #avatar {
      width: 100%;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<h2>ChatUp</h2>

<div id="auth">
  <div class="tab-buttons">
    <button onclick="switchTab('signup-tab')">Đăng ký</button>
    <button onclick="switchTab('login-tab')">Đăng nhập</button>
  </div>

  <div id="signup-tab" class="tab-content active">
    <input id="signup-email" placeholder="Email">
    <input id="signup-pass" type="password" placeholder="Mật khẩu (>=6)">
    <input id="signup-name" placeholder="Tên hiển thị">
    <input id="signup-dob" type="date">
    <input id="signup-avatar" placeholder="URL Ảnh đại diện">
    <button onclick="signup()">Đăng ký</button>
  </div>

  <div id="login-tab" class="tab-content">
    <input id="login-email" placeholder="Email">
    <input id="login-pass" type="password" placeholder="Mật khẩu">
    <button onclick="login()">Đăng nhập</button>
  </div>
</div>

<div id="chat-ui" style="display:none;">
  <p>Xin chào, <span id="username"></span>! <button onclick="logout()">Đăng xuất</button></p>
  <div id="chat"></div>
  <input id="message" placeholder="Nhập tin nhắn..." onkeypress="if(event.key==='Enter') sendMessage()">
  <button onclick="sendMessage()">Gửi</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAry2Wta_2_mWxfplmfnpHn3aBSpH-ZDqU",
    authDomain: "chatup-7fed7.firebaseapp.com",
    projectId: "chatup-7fed7",
    storageBucket: "chatup-7fed7.appspot.com",
    messagingSenderId: "287838782402",
    appId: "1:287838782402:web:c4fd4b4ce02c3238530c5b",
    measurementId: "G-2CXCQNLQXP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.switchTab = function(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
  }

  async function signup() {
    const email = document.getElementById("signup-email").value.trim();
    const pass = document.getElementById("signup-pass").value.trim();
    const name = document.getElementById("signup-name").value.trim();
    const dob = document.getElementById("signup-dob").value.trim();
    const avatar = document.getElementById("signup-avatar").value.trim();

    if (!email || !pass || !name || !dob) return alert("Vui lòng điền đầy đủ thông tin.");
    if (!email.includes("@")) return alert("Email không hợp lệ.");
    if (pass.length < 6) return alert("Mật khẩu phải từ 6 ký tự.");

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await setDoc(doc(db, "users", cred.user.uid), { name, dob, email, avatar });
      alert("Đăng ký thành công!");
    } catch (err) {
      alert("Lỗi: Tài khoản đã tồn tại hoặc dữ liệu không hợp lệ.");
    }
  }

  async function login() {
    const email = document.getElementById("login-email").value.trim();
    const pass = document.getElementById("login-pass").value.trim();

    if (!email || !pass) return alert("Vui lòng nhập email và mật khẩu.");

    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      alert("Lỗi: Email hoặc mật khẩu không đúng.");
    }
  }

  async function logout() {
    await signOut(auth);
    location.reload();
  }

  async function sendMessage() {
    const msg = document.getElementById("message").value.trim();
    const user = auth.currentUser;
    if (!user || !msg) return;

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    const userData = userSnap.data();
    await addDoc(collection(db, "messages"), {
      name: userData.name,
      avatar: userData.avatar || "",
      text: msg,
      time: new Date()
    });

    document.getElementById("message").value = "";
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById("auth").style.display = "none";
      document.getElementById("chat-ui").style.display = "block";

      const userSnap = await getDoc(doc(db, "users", user.uid));
      const userData = userSnap.data();
      document.getElementById("username").innerText = userData.name;

      const q = query(collection(db, "messages"), orderBy("time"));
      onSnapshot(q, (snapshot) => {
        const chat = document.getElementById("chat");
        chat.innerHTML = "";

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement("div");
          const date = data.time?.toDate();
          const timeStr = date ? date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' }) : '';
          div.classList.add("msg", data.name === userData.name ? "my-msg" : "other-msg");

          const avatar = data.avatar ? `<img src="${data.avatar}" width="24" height="24" style="border-radius:50%; vertical-align:middle;">` : '';
          div.innerHTML = `${avatar} <b>${data.name}</b> <small>${timeStr}</small><br>${data.text}`;
          chat.appendChild(div);
        });

        chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
      });
    }
  });

  window.signup = signup;
  window.login = login;
  window.sendMessage = sendMessage;
  window.logout = logout;
</script>

</body>
</html>

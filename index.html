<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ChatUp Professional</title>
  <meta name="theme-color" content="#4a90e2" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .dark-mode { background: #1a202c; color: #e2e8f0; }
    .dark-mode .bg-white { background: #2d3748; }
    .dark-mode .bg-gray-100 { background: #1a202c; }
    .dark-mode .border-gray-200 { border-color: #4a5568; }
    .dark-mode input, .dark-mode button { background: #4a5568; color: #e2e8f0; border-color: #718096; }
    .tab-button { transition: all 0.2s ease; }
    .tab-button:hover { background: #2b6cb0; }
    .friend-item, .request-item, .search-item { transition: all 0.2s ease; }
    .friend-item:hover, .request-item:hover, .search-item:hover { transform: translateY(-2px); }
    .message { transition: all 0.2s ease; }
    .message:hover { transform: translateY(-2px); }
    .message.mine { margin-left: auto; border-bottom-right-radius: 0; }
    .message.theirs { margin-right: auto; border-bottom-left-radius: 0; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h2 class="text-2xl font-semibold text-blue-600 mb-6">Khoaken Chat</h2>

    <div id="auth" class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex gap-4 mb-4">
        <button class="tab-button flex-1 bg-blue-600 text-white py-2 rounded-lg" onclick="switchTab('signup-tab')">ƒêƒÉng k√Ω</button>
        <button class="tab-button flex-1 bg-blue-600 text-white py-2 rounded-lg" onclick="switchTab('login-tab')">ƒêƒÉng nh·∫≠p</button>
      </div>
      <div id="signup-tab" class="tab-content">
        <input id="signup-email" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Email">
        <input id="signup-pass" type="password" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="M·∫≠t kh·∫©u (>=6)">
        <input id="signup-name" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="T√™n hi·ªÉn th·ªã">
        <input id="signup-dob" type="date" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600">
        <button onclick="signup()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">ƒêƒÉng k√Ω</button>
      </div>
      <div id="login-tab" class="tab-content hidden">
        <input id="login-email" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Email">
        <input id="login-pass" type="password" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="M·∫≠t kh·∫©u">
        <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">ƒêƒÉng nh·∫≠p</button>
      </div>
    </div>

    <div id="friends-ui" class="hidden">
      <div class="flex items-center justify-between mb-6">
        <p class="text-lg">Xin ch√†o, <span id="username" class="font-semibold"></span>!</p>
        <div class="flex items-center gap-4">
          <button id="dark-toggle" class="text-xl bg-transparent border-none">üåô</button>
          <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">ƒêƒÉng xu·∫•t</button>
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h3 class="text-lg font-semibold mb-4">C·∫≠p nh·∫≠t h·ªì s∆°</h3>
        <input id="new-name" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="T√™n m·ªõi">
        <button onclick="updateProfile()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">C·∫≠p nh·∫≠t</button>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <input id="search-user" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="T√¨m email ng∆∞·ªùi d√πng...">
        <button onclick="searchUser()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">T√¨m ki·∫øm</button>
        <div id="search-result" class="mt-4"></div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h3 class="text-lg font-semibold mb-4">Danh s√°ch b·∫°n b√®</h3>
        <div id="friends-list"></div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h3 class="text-lg font-semibold mb-4">Ch·ªù x√°c nh·∫≠n</h3>
        <div id="pending-requests"></div>
      </div>

      <div id="chat-box" class="hidden bg-white p-6 rounded-lg shadow-md">
        <h3 id="chat-with" class="text-lg font-semibold mb-4">Chat v·ªõi ...</h3>
        <div id="chat-messages" class="h-64 overflow-y-auto bg-gray-100 p-4 rounded-lg mb-4"></div>
        <input id="chat-input" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button onclick="sendMessage()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">G·ª≠i</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile as authUpdateProfile } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAry2Wta_2_mWxfplmfnpHn3aBSpH-ZDqU",
    authDomain: "chatup-7fed7.firebaseapp.com",
    projectId: "chatup-7fed7",
    storageBucket: "chatup-7fed7.appspot.com",
    messagingSenderId: "287838782402",
    appId: "1:287838782402:web:c4fd4b4ce02c3238530c5b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  window.switchTab = function(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.toggle('hidden', el.id !== tabId));
  }

  async function signup() {
    const email = document.getElementById("signup-email").value.trim();
    const pass = document.getElementById("signup-pass").value.trim();
    const name = document.getElementById("signup-name").value.trim();
    const dob = document.getElementById("signup-dob").value.trim();
    if (!email || !pass || !name || !dob) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß.");

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await setDoc(doc(db, "users", cred.user.uid), { name, dob, email });
    alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
    } catch (err) {
      alert("L·ªói: " + err.message);
    }
  }

  async function login() {
    const email = document.getElementById("login-email").value.trim();
    const pass = document.getElementById("login-pass").value.trim();
    if (!email || !pass) return alert("Nh·∫≠p ƒë·∫ßy ƒë·ªß email v√† m·∫≠t kh·∫©u.");

    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      alert("L·ªói: " + err.message);
    }
  }

  async function logout() {
    await signOut(auth);
    location.reload();
  }

  window.searchUser = async function() {
    const email = document.getElementById('search-user').value.trim();
    if (!email) return;
    const q = query(collection(db, "users"), where("email", "==", email));
    const snapshot = await getDocs(q);
    const resultDiv = document.getElementById('search-result');
    resultDiv.innerHTML = '';

    if (snapshot.empty) {
      resultDiv.innerText = "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.";
      return;
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const uid = docSnap.id;
      const div = document.createElement('div');
      div.className = 'search-item bg-gray-50 p-3 rounded-lg flex justify-between items-center';
      div.innerHTML = `<span class="font-semibold">${data.name}</span> (${data.email}) <button onclick="sendFriendRequest('${uid}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">K·∫øt b·∫°n</button>`;
      resultDiv.appendChild(div);
    });
  }

  window.sendFriendRequest = async function(targetUid) {
    const user = auth.currentUser;
    if (!user) return;
    await setDoc(doc(db, "friend_requests", `${user.uid}_${targetUid}`), { from: user.uid, to: targetUid, status: "pending" });
    alert("ƒê√£ g·ª≠i l·ªùi m·ªùi!");
  }

  window.acceptFriendRequest = async function(requestId, fromUid) {
    const user = auth.currentUser;
    if (!user) return;

    await setDoc(doc(db, "friends", user.uid, "list", fromUid), { since: new Date() });
    await setDoc(doc(db, "friends", fromUid, "list", user.uid), { since: new Date() });

    await updateDoc(doc(db, "friend_requests", requestId), { status: "accepted" });
    alert("ƒê√£ ch·∫•p nh·∫≠n!");
  }

  async function loadFriendsAndRequests(uid) {
    const friendsList = document.getElementById('friends-list');
    const pendingList = document.getElementById('pending-requests');

    const friendsRef = collection(db, "friends", uid, "list");
    onSnapshot(friendsRef, async (snapshot) => {
      friendsList.innerHTML = '';
      snapshot.forEach(async (docSnap) => {
        const friendId = docSnap.id;
        const userSnap = await getDoc(doc(db, "users", friendId));
        const data = userSnap.data();
        const div = document.createElement('div');
        div.className = 'friend-item bg-gray-50 p-3 rounded-lg flex justify-between items-center';
        div.innerHTML = `<span class="font-semibold">${data?.name || "Ng∆∞·ªùi d√πng"}</span> <button onclick="openChatPage('${friendId}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">Nh·∫Øn tin</button>`;
        friendsList.appendChild(div);
      });
    });

    const requestsRef = collection(db, "friend_requests");
    const q2 = query(requestsRef, where("to", "==", uid), where("status", "==", "pending"));
    onSnapshot(q2, (snapshot) => {
      pendingList.innerHTML = '';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const fromUid = data.from;
        const div = document.createElement('div');
        div.className = 'request-item bg-gray-50 p-3 rounded-lg flex justify-between items-center';
        div.innerHTML = `<span class="font-semibold">${fromUid}</span> <button onclick="acceptFriendRequest('${docSnap.id}', '${fromUid}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">Ch·∫•p nh·∫≠n</button>`;
        pendingList.appendChild(div);
      });
    });
  }

  window.updateProfile = async function() {
    const user = auth.currentUser;
    if (!user) return;
    const name = document.getElementById('new-name').value.trim();

    const userDoc = doc(db, "users", user.uid);
    const updates = {};

    if (name) updates.name = name;

    if (name) {
      await authUpdateProfile(user, { displayName: name });
    }

    await updateDoc(userDoc, updates);
    if (name) document.getElementById('username').innerText = name;
    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
  }

  window.openChatPage = function(friendId) {
    window.location.href = `chat.html?uid=${friendId}`;
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById("auth").classList.add("hidden");
      document.getElementById("friends-ui").classList.remove("hidden");
      const userSnap = await getDoc(doc(db, "users", user.uid));
      const userData = userSnap.data();
      document.getElementById("username").innerText = userData.name;
      loadFriendsAndRequests(user.uid);
    } else {
      document.getElementById("auth").classList.remove("hidden");
      document.getElementById("friends-ui").classList.add("hidden");
    }
  });

  document.getElementById("dark-toggle").addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
  });

  if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");

  window.signup = signup;
  window.login = login;
  window.logout = logout;
</script>
</body>
</html>

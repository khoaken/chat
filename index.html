<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ChatUp</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; margin-bottom: 10px; padding: 10px; }
    .msg { margin: 5px 0; }
  </style>
</head>
<body>

<h2>ChatUp</h2>

<div id="auth">
  <h2>Đăng ký</h2>
  <input id="signup-email" placeholder="Email"><br>
  <input id="signup-pass" type="password" placeholder="Mật khẩu"><br>
  <input id="signup-name" placeholder="Tên thật"><br>
  <input id="signup-dob" type="date"><br>
  <button onclick="signup()">Đăng ký</button>

  <h2>Đăng nhập</h2>
  <input id="login-email" placeholder="Email"><br>
  <input id="login-pass" type="password" placeholder="Mật khẩu"><br>
  <button onclick="login()">Đăng nhập</button>
</div>

<div id="chat-ui" style="display:none;">
  <p>Xin chào, <span id="username"></span>!</p>
  <div id="chat" style="border:1px solid #ccc; padding:10px; height:200px; overflow:auto;"></div>
  <input id="message" placeholder="Nhập tin nhắn...">
  <button onclick="sendMessage()">Gửi</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    query,
    orderBy,
    setDoc,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAry2Wta_2_mWxfplmfnpHn3aBSpH-ZDqU",
    authDomain: "chatup-7fed7.firebaseapp.com",
    projectId: "chatup-7fed7",
    storageBucket: "chatup-7fed7.firebasestorage.app",
    messagingSenderId: "287838782402",
    appId: "1:287838782402:web:c4fd4b4ce02c3238530c5b",
    measurementId: "G-2CXCQNLQXP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Đăng ký
  async function signup() {
    const email = document.getElementById("signup-email").value;
    const pass = document.getElementById("signup-pass").value;
    const name = document.getElementById("signup-name").value;
    const dob = document.getElementById("signup-dob").value;

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await setDoc(doc(db, "users", cred.user.uid), {
        name, dob, email
      });
      alert("Đăng ký thành công!");
    } catch (err) {
      alert("Lỗi: " + err.message);
    }
  }

  // Đăng nhập
  async function login() {
    const email = document.getElementById("login-email").value;
    const pass = document.getElementById("login-pass").value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      alert("Lỗi: " + err.message);
    }
  }

  // Check trạng thái đăng nhập
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById("auth").style.display = "none";
      document.getElementById("chat-ui").style.display = "block";

      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      const userName = userSnap.data().name || "Ẩn danh";

      document.getElementById("username").innerText = userName;

      const q = query(collection(db, "messages"), orderBy("time"));
      onSnapshot(q, (snapshot) => {
        const chat = document.getElementById("chat");
        chat.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.classList.add("msg");
          div.innerText = `${data.name}: ${data.text}`;
          chat.appendChild(div);
        });
      });
    }
  });

  // Gửi tin nhắn
  async function sendMessage() {
    const msg = document.getElementById("message").value;
    const user = auth.currentUser;
    if (!user) return;

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    const userName = userSnap.data().name;

    await addDoc(collection(db, "messages"), {
      name: userName,
      text: msg,
      time: new Date()
    });

    document.getElementById("message").value = "";
  }

  // Export ra window để dùng trong HTML onclick
  window.signup = signup;
  window.login = login;
  window.sendMessage = sendMessage;
</script>

</body>
</html>

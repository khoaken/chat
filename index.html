<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KKChat</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ChatUp" />
  <meta name="theme-color" content="#4a90e2" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .dark-mode { background: #1a202c; color: #e2e8f0; }
    .dark-mode .bg-white { background: #2d3748; }
    .dark-mode .bg-gray-100 { background: #1a202c; }
    .dark-mode .border-gray-200 { border-color: #4a5568; }
    .dark-mode input, .dark-mode button { background: #4a5568; color: #e2e8f0; border-color: #718096; }
    .friend-item { transition: all 0.2s ease; }
    .friend-item:hover { transform: translateY(-2px); }
    .profile-pic { object-fit: cover; border: 2px solid #4a90e2; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-semibold text-blue-600">KKChat</h1>
      <div class="flex items-center gap-4">
        <button id="dark-toggle" class="text-xl bg-transparent border-none">üåô</button>
        <button id="logout-button" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-xl font-semibold mb-4">Th√¥ng tin ng∆∞·ªùi d√πng</h2>
      <div class="flex items-center gap-6 mb-4">
        <img id="user-pic" src="https://via.placeholder.com/100" alt="Avatar" class="w-24 h-24 rounded-full profile-pic">
        <div>
          <h3 id="user-name" class="text-lg font-semibold"></h3>
          <p id="user-coins" class="text-gray-600"></p>
        </div>
      </div>
      <button onclick="window.location.href='profile.html'" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Xem h·ªì s∆°</button>
    </div>

    <div id="admin-section" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
      <h2 class="text-xl font-semibold mb-4">Qu·∫£n l√Ω Admin</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">C·∫•p xu</label>
        <input id="admin-email" type="email" class="w-full p-2 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Email ng∆∞·ªùi d√πng">
        <input id="admin-coins" type="number" class="w-full p-2 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="S·ªë xu">
        <button id="admin-give-coins" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">C·∫•p xu</button>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">R√∫t xu</label>
        <input id="admin-withdraw-email" type="email" class="w-full p-2 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Email ng∆∞·ªùi d√πng">
        <input id="admin-withdraw-coins" type="number" class="w-full p-2 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="S·ªë xu c·∫ßn r√∫t">
        <button id="admin-withdraw-coins" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">R√∫t xu</button>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Qu·∫£n l√Ω t√≠ch xanh</label>
        <input id="verify-email" type="email" class="w-full p-2 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Email ng∆∞·ªùi d√πng">
        <div class="flex gap-2">
          <button id="verify-button" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">C·∫•p t√≠ch xanh</button>
          <button id="unverify-button" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">H·ªßy t√≠ch xanh</button>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-xl font-semibold mb-4">Th√™m b·∫°n</h2>
      <input id="friend-email" type="email" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Nh·∫≠p email b·∫°n b√®">
      <button id="add-friend-button" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Th√™m b·∫°n</button>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Danh s√°ch b·∫°n b√®</h2>
      <div id="friends-list"></div>
    </div>

    <div class="mt-6">
      <button onclick="window.location.href='cacuoc.html'" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700">Ch∆°i T√†i X·ªâu</button>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAry2Wta_2_mWxfplmfnpHn3aBSpH-ZDqU",
  authDomain: "chatup-7fed7.firebaseapp.com",
  projectId: "chatup-7fed7",
  storageBucket: "chatup-7fed7.appspot.com",
  messagingSenderId: "287838782402",
  appId: "1:287838782402:web:c4fd4b4ce02c3238530c5b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "khoakenlol@gmail.com";

function loadUserInfo(userData) {
  document.getElementById("user-name").innerText = userData.name || "Ng∆∞·ªùi d√πng";
  document.getElementById("user-name").innerHTML += userData.isVerified ? " ‚úÖ" : "";
  document.getElementById("user-coins").innerText = `Xu: ${userData.coins || 0}`;
  const userPic = document.getElementById("user-pic");
  userPic.src = userData.profilePic || "https://via.placeholder.com/100";
}

function loadFriends(uid) {
  const friendsList = document.getElementById("friends-list");
  const friendsRef = collection(db, "friends", uid, "list");
  onSnapshot(friendsRef, async (snapshot) => {
    friendsList.innerHTML = "";
    for (const docSnap of snapshot.docs) {
      const friendId = docSnap.id;
      const userSnap = await getDoc(doc(db, "users", friendId));
      const data = userSnap.data();
      const div = document.createElement("div");
      div.className = "friend-item bg-gray-50 p-3 rounded-lg flex justify-between items-center mb-2";
      div.innerHTML = `
        <span class="font-semibold">${data?.name || "Ng∆∞·ªùi d√πng"} ${data?.isVerified ? "‚úÖ" : ""}</span>
        <div class="flex gap-2">
          <button onclick="window.location.href='profile.html?uid=${friendId}'" class="bg-gray-600 text-white px-3 py-1 rounded-lg hover:bg-gray-700">Xem h·ªì s∆°</button>
          <button onclick="window.location.href='chat.html?uid=${friendId}'" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">Nh·∫Øn tin</button>
        </div>
      `;
      friendsList.appendChild(div);
    }
  });
}

document.getElementById("logout-button").addEventListener("click", async () => {
  try {
    await signOut(auth);
    window.location.href = "login.html";
  } catch (error) {
    alert(`L·ªói khi ƒëƒÉng xu·∫•t: ${error.message}`);
  }
});

document.getElementById("add-friend-button").addEventListener("click", async () => {
  const friendEmail = document.getElementById("friend-email").value.trim();
  if (!friendEmail) {
    alert("Vui l√≤ng nh·∫≠p email b·∫°n b√®!");
    return;
  }

  try {
    const usersRef = collection(db, "users");
    const userSnap = await getDocs(usersRef);
    let friendUid = null;
    userSnap.forEach(doc => {
      if (doc.data().email === friendEmail) {
        friendUid = doc.id;
      }
    });

    if (!friendUid) {
      alert("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email n√†y!");
      return;
    }

    if (friendUid === auth.currentUser.uid) {
      alert("B·∫°n kh√¥ng th·ªÉ th√™m ch√≠nh m√¨nh!");
      return;
    }

    await setDoc(doc(db, "friends", auth.currentUser.uid, "list", friendUid), { added: true });
    document.getElementById("friend-email").value = "";
    alert("Th√™m b·∫°n th√†nh c√¥ng!");
  } catch (error) {
    alert(`L·ªói khi th√™m b·∫°n: ${error.message}`);
  }
});

document.getElementById("admin-give-coins").addEventListener("click", async () => {
  const email = document.getElementById("admin-email").value.trim();
  const coins = parseInt(document.getElementById("admin-coins").value);
  if (!email || isNaN(coins) || coins <= 0) {
    alert("Vui l√≤ng nh·∫≠p email v√† s·ªë xu h·ª£p l·ªá!");
    return;
  }

  try {
    const usersRef = collection(db, "users");
    const userSnap = await getDocs(usersRef);
    let targetUid = null;
    userSnap.forEach(doc => {
      if (doc.data().email === email) {
        targetUid = doc.id;
      }
    });

    if (!targetUid) {
      alert("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email n√†y!");
      return;
    }

    const userRef = doc(db, "users", targetUid);
    const userDoc = await getDoc(userRef);
    const currentCoins = userDoc.data().coins || 0;
    await updateDoc(userRef, { coins: currentCoins + coins });
    alert(`C·∫•p ${coins} xu cho ${email} th√†nh c√¥ng!`);
    document.getElementById("admin-email").value = "";
    document.getElementById("admin-coins").value = "";
  } catch (error) {
    alert(`L·ªói khi c·∫•p xu: ${error.message}`);
  }
});

document.getElementById("admin-withdraw-coins").addEventListener("click", async () => {
  const email = document.getElementById("admin-withdraw-email").value.trim();
  const coins = parseInt(document.getElementById("admin-withdraw-coins").value);
  if (!email || isNaN(coins) || coins <= 0) {
    alert("Vui l√≤ng nh·∫≠p email v√† s·ªë xu h·ª£p l·ªá!");
    return;
  }

  try {
    const usersRef = collection(db, "users");
    const userSnap = await getDocs(usersRef);
    let targetUid = null;
    userSnap.forEach(doc => {
      if (doc.data().email === email) {
        targetUid = doc.id;
      }
    });

    if (!targetUid) {
      alert("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email n√†y!");
      return;
    }

    const userRef = doc(db, "users", targetUid);
    const userDoc = await getDoc(userRef);
    const currentCoins = userDoc.data().coins || 0;
    if (currentCoins < coins) {
      alert(`S·ªë xu hi·ªán t·∫°i (${currentCoins}) kh√¥ng ƒë·ªß ƒë·ªÉ r√∫t ${coins} xu!`);
      return;
    }

    await updateDoc(userRef, { coins: currentCoins - coins });
    alert(`R√∫t ${coins} xu t·ª´ ${email} th√†nh c√¥ng!`);
    document.getElementById("admin-withdraw-email").value = "";
    document.getElementById("admin-withdraw-coins").value = "";
  } catch (error) {
    alert(`L·ªói khi r√∫t xu: ${error.message}`);
  }
});

document.getElementById("verify-button").addEventListener("click", async () => {
  const email = document.getElementById("verify-email").value.trim();
  if (!email) {
    alert("Vui l√≤ng nh·∫≠p email ng∆∞·ªùi d√πng!");
    return;
  }

  try {
    const usersRef = collection(db, "users");
    const userSnap = await getDocs(usersRef);
    let targetUid = null;
    userSnap.forEach(doc => {
      if (doc.data().email === email) {
        targetUid = doc.id;
      }
    });

    if (!targetUid) {
      alert("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email n√†y!");
      return;
    }

    const userRef = doc(db, "users", targetUid);
    await updateDoc(userRef, { isVerified: true });
    alert(`C·∫•p t√≠ch xanh cho ${email} th√†nh c√¥ng!`);
    document.getElementById("verify-email").value = "";
  } catch (error) {
    alert(`L·ªói khi c·∫•p t√≠ch xanh: ${error.message}`);
  }
});

document.getElementById("unverify-button").addEventListener("click", async () => {
  const email = document.getElementById("verify-email").value.trim();
  if (!email) {
    alert("Vui l√≤ng nh·∫≠p email ng∆∞·ªùi d√πng!");
    return;
  }

  try {
    const usersRef = collection(db, "users");
    const userSnap = await getDocs(usersRef);
    let targetUid = null;
    userSnap.forEach(doc => {
      if (doc.data().email === email) {
        targetUid = doc.id;
      }
    });

    if (!targetUid) {
      alert("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email n√†y!");
      return;
    }

    const userRef = doc(db, "users", targetUid);
    await updateDoc(userRef, { isVerified: false });
    alert(`H·ªßy t√≠ch xanh cho ${email} th√†nh c√¥ng!`);
    document.getElementById("verify-email").value = "";
  } catch (error) {
    alert(`L·ªói khi h·ªßy t√≠ch xanh: ${error.message}`);
  }
});

document.getElementById("verify-email").addEventListener("input", async () => {
  const email = document.getElementById("verify-email").value.trim();
  if (!email) {
    document.getElementById("verify-button").innerText = "C·∫•p t√≠ch xanh";
    return;
  }

  try {
    const usersRef = collection(db, "users");
    const userSnap = await getDocs(usersRef);
    let targetUid = null;
    userSnap.forEach(doc => {
      if (doc.data().email === email) {
        targetUid = doc.id;
      }
    });

    if (targetUid) {
      const userDoc = await getDoc(doc(db, "users", targetUid));
      const isVerified = userDoc.data().isVerified || false;
      document.getElementById("verify-button").innerText = isVerified ? "C·∫•p l·∫°i t√≠ch xanh" : "C·∫•p t√≠ch xanh";
    }
  } catch (error) {
    console.error("L·ªói khi ki·ªÉm tra tr·∫°ng th√°i t√≠ch xanh:", error);
  }
});

document.getElementById("dark-toggle").addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
});

if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      await setDoc(userRef, {
        name: user.displayName || "Ng∆∞·ªùi d√πng",
        email: user.email,
        coins: 0,
        isVerified: false
      });
    }
    const userData = userSnap.exists() ? userSnap.data() : (await getDoc(userRef)).data();
    loadUserInfo(userData);
    loadFriends(user.uid);

    if (user.email === ADMIN_EMAIL) {
      document.getElementById("admin-section").classList.remove("hidden");
    }
  } catch (error) {
    alert(`L·ªói khi t·∫£i th√¥ng tin: ${error.message}`);
    window.location.href = "login.html";
  }
});
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'932c0e111e5a4564',t:'MTc0NTA2MjA3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
